version: '3.8'

services:
  # ==================== BASES DE DATOS ====================
  
  # PostgreSQL para OrdersService
  postgres:
    image: postgres:16-alpine
    container_name: orders_db
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: serdev
      POSTGRES_PASSWORD: nifer2030
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U serdev -d orders_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL para CatalogoService
  catalogo-db:
    image: mysql:8.0
    container_name: catalogo-db
    environment:
      MYSQL_DATABASE: db_catalogo
      MYSQL_ROOT_PASSWORD: password
      MYSQL_PASSWORD: password
      MYSQL_USER: sail
    volumes:
      - catalogo_dbdata:/var/lib/mysql
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL para UserService
  user-db:
    image: mysql:8.0
    container_name: user-db
    ports:
      - "3307:3306"
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pedidos_user_service
      MYSQL_USER: user
      MYSQL_PASSWORD: yes
    volumes:
      - user_mysql_data:/var/lib/mysql
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 30s

  # Redis para CatalogoService
  redis:
    image: redis:alpine
    container_name: redis
    networks:
      - app-network
    restart: unless-stopped

  # ==================== SERVICIOS ====================

  # OrdersService (NestJS)
  orders-service:
    build: 
      context: ./OrdersService
      dockerfile: Dockerfile
    container_name: orders-service
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USERNAME: serdev
      DB_PASSWORD: nifer2030
      DB_DATABASE: orders_db
      # Application Configuration
      NODE_ENV: production
      PORT: "3000"
      # JWT Configuration
      JWT_SECRET: grupo8
      # RabbitMQ Configuration
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      ORDERS_QUEUE: order_events
      PAYMENT_QUEUE: payment_events
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # PaymentNotificationsService (Node.js)
  notification-service:
    build:
      context: ./PaymentNotificationsService
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      - PORT=3004
      - NODE_ENV=development
      - EMAIL_USER=rosicela.pinedo.quespi@gmail.com
      - EMAIL_PASSWORD=rjaktnlfqwbjdmtc
      - EMAIL_FROM=Notificaciones <rosicela.pinedo.quespi@gmail.com>
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - ORDERS_SERVICE_URL=http://orders-service:3000
      - JWT_TOKEN=grupo8
      - EMAILS_QUEUE=emails_queue
      - PAYMENT_QUEUE=payment_events
      - ORDER_QUEUE=order_events
    depends_on:
      rabbitmq:
        condition: service_healthy
      orders-service:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CatalogoService (Laravel/PHP)
  catalogo-service:
    build:
      context: ./CatalogoSerice
      dockerfile: Dockerfile
    container_name: catalogo-service
    working_dir: /var/www
    volumes:
      - ./CatalogoSerice/app:/var/www/app
      - ./CatalogoSerice/routes:/var/www/routes
      - ./CatalogoSerice/resources:/var/www/resources
      - ./CatalogoSerice/public:/var/www/public
    environment:
      - APP_NAME=Laravel
      - APP_ENV=local
      - APP_KEY=base64:N5T+qqjnIAtQgKvD2F84QuNxUbj8Xa7u81dO/NaI8OM=
      - APP_DEBUG=true
      - APP_URL=http://localhost
      - DB_CONNECTION=mysql
      - DB_HOST=catalogo-db
      - DB_PORT=3306
      - DB_DATABASE=db_catalogo
      - DB_USERNAME=sail
      - DB_PASSWORD=password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      catalogo-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

  # UserService (Django)
  user-service:
    build:
      context: ./UserService/user-service
      dockerfile: Dockerfile
    container_name: user-service
    command: gunicorn user_service.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./UserService/user-service:/app
      - user_static_volume:/app/staticfiles
    environment:
      - SECRET_KEY=grupo8
      - DB_NAME=pedidos_user_service
      - DB_USER=user
      - DB_PASSWORD=yes
      - DB_HOST=user-db
      - DB_PORT=3306
      - DEBUG=1
      - ALLOWED_HOSTS=localhost,127.0.0.1,user-service
    depends_on:
      user-db:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # Frontend (React/Vite)
  pedidos-front:
    build:
      context: ./Pedidos-front
      dockerfile: Dockerfile
    container_name: pedidos-front
    environment:
      - NODE_ENV=production
      # Variables para conectar con los servicios backend a trav√©s del proxy
      - VITE_API_BASE_URL=/
    networks:
      - app-network
    restart: unless-stopped

  # ==================== PROXY NGINX ====================

  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - user_static_volume:/usr/share/nginx/html/static
    depends_on:
      - pedidos-front
      - orders-service
      - catalogo-service
      - user-service
      - notification-service
    networks:
      - app-network
    restart: unless-stopped

volumes:
  postgres_data:
  catalogo_dbdata:
  user_mysql_data:
  rabbitmq_data:
  user_static_volume:

networks:
  app-network:
    driver: bridge